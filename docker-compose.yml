version: '3.8'

# Docker Secrets
secrets:
  mongodb_uri:
    file: ./secrets/mongodb_uri.txt
  redis_url:
    file: ./secrets/redis_url.txt
  session_secret:
    file: ./secrets/session_secret.txt

# Networks
networks:
  multiservice-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  
  backend-network:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/16

# Volumes
volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  nginx_logs:
    driver: local
  app_logs:
    driver: local

services:
  # Custom Base Images (build first)
  node-base:
    build:
      context: ./docker-base-images
      dockerfile: node-base.Dockerfile
    image: multiservice/node-base:latest
    command: ["echo", "Base image built"]

  nginx-base:
    build:
      context: ./docker-base-images
      dockerfile: nginx-base.Dockerfile
    image: multiservice/nginx-base:latest
    command: ["echo", "Base image built"]

  # MongoDB Database
  mongodb:
    image: mongo:7-jammy
    container_name: multiservice-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: multiservice
    volumes:
      - mongodb_data:/data/db
      - ./logs/mongodb:/var/log/mongodb
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - backend-network
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=mongodb"

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: multiservice-redis
    restart: unless-stopped
    command: >
      redis-server 
      --appendonly yes 
      --requirepass redis123
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
      - ./logs/redis:/var/log/redis
    networks:
      - backend-network
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
        labels: "service=redis"

  # API Service
  api-service:
    build:
      context: ./api-service
      dockerfile: Dockerfile
    container_name: multiservice-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGODB_URI_FILE: /run/secrets/mongodb_uri
      REDIS_URL_FILE: /run/secrets/redis_url
      SESSION_SECRET_FILE: /run/secrets/session_secret
    secrets:
      - mongodb_uri
      - redis_url
      - session_secret
    volumes:
      - app_logs:/app/logs
    networks:
      - multiservice-network
      - backend-network
    ports:
      - "3000:3000"
    depends_on:
      node-base:
        condition: service_completed_successfully
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=api"

  # Web Application
  web-app:
    build:
      context: ./web-app
      dockerfile: Dockerfile
    container_name: multiservice-web
    restart: unless-stopped
    environment:
      REACT_APP_API_URL: /api
    volumes:
      - app_logs:/var/log/nginx
    networks:
      - multiservice-network
    ports:
      - "3001:80"
    depends_on:
      api-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=web"

  # Nginx Reverse Proxy
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: multiservice-nginx
    restart: unless-stopped
    volumes:
      - nginx_logs:/var/log/nginx
    networks:
      - multiservice-network
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      nginx-base:
        condition: service_completed_successfully
      web-app:
        condition: service_healthy
      api-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "10"
        labels: "service=nginx"

  # Log Rotation Service
  logrotate:
    image: alpine:latest
    container_name: multiservice-logrotate
    restart: unless-stopped
    volumes:
      - nginx_logs:/logs/nginx
      - app_logs:/logs/app
      - ./logrotate.conf:/etc/logrotate.conf:ro
      - ./logrotate.d:/etc/logrotate.d:ro
    command: >
      sh -c "
        apk add --no-cache logrotate &&
        while true; do
          logrotate -f /etc/logrotate.conf
          sleep 3600
        done
      "
    networks:
      - multiservice-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # Monitoring (Optional - Health Dashboard)
  health-monitor:
    image: alpine:latest
    container_name: multiservice-monitor
    restart: unless-stopped
    volumes:
      - ./health-monitor.sh:/health-monitor.sh:ro
    command: >
      sh -c "
        apk add --no-cache curl &&
        chmod +x /health-monitor.sh &&
        while true; do
          /health-monitor.sh
          sleep 60
        done
      "
    networks:
      - multiservice-network
    depends_on:
      - nginx
      - api-service
      - web-app
      - mongodb
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"